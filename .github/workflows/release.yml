name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

env:
  ELIXIR_VERSION: "1.17.3"
  OTP_VERSION: "27.0"

jobs:
  publish:
    name: Publish to Hex.pm
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event.inputs.version
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Install dependencies
        run: |
          mix local.rebar --force
          mix local.hex --force
          mix deps.get
      
      - name: Run tests
        run: mix test
      
      - name: Check formatting
        run: mix format --check-formatted
      
      - name: Build docs
        run: mix docs
      
      - name: Publish to Hex.pm
        env:
          HEX_API_KEY: ${{ secrets.HEX_API_KEY }}
        run: |
          mix hex.publish --yes
      
      - name: Create GitHub Release Assets
        if: github.event_name == 'release'
        run: |
          mix hex.build
          mv ash_phoenix_translations-*.tar ash_phoenix_translations-${{ github.event.release.tag_name }}.tar
      
      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./ash_phoenix_translations-${{ github.event.release.tag_name }}.tar
          asset_name: ash_phoenix_translations-${{ github.event.release.tag_name }}.tar
          asset_content_type: application/x-tar